/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset enforces a security model for a social media application.
 * Users have exclusive write control over their own content (profiles, posts),
 * while social content is publicly readable to authenticated users. It also
 * guarantees username uniqueness across the platform.
 *
 * ## Data Structure
 * 1.  `/userProfiles/{userProfileId}`: Stores public user profile data.
 * 2.  `/userProfiles/{userProfileId}/habits/{habitId}`: Stores private habits for a user.
 * 3.  `/usernames/{username}`: A technical collection to enforce unique usernames.
 * 4.  `/global_posts/{postId}`: A single, top-level collection for all public posts.
 * 5.  `/global_posts/{postId}/likes/{likeId}`: Likes are a subcollection of posts.
 *
 * ## Key Security Decisions
 * -   **Default Deny**: All paths are closed by default.
 * -   **Public Read, Owner Write**: Social content (profiles, posts) is readable
 *     by any authenticated user but is only writable by the content owner.
 * -   **Username Uniqueness**: Enforced via a `/usernames` collection and a
 *     transaction during profile creation.
 * -   **Simplified Post Querying**: A single `global_posts` collection allows for
 *     simple, secure, and efficient querying for the main feed, avoiding complex
 *     collection group queries.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isCreatingUniqueUsername(userId) {
      return getAfter(/databases/$(database)/documents/usernames/$(request.resource.data.username)).data.uid == userId;
    }

    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

    /**
     * @description Private collection to enforce unique usernames.
     */
    match /usernames/{username} {
      allow get, list: if false;
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
      allow update: if false;
      allow delete: if isExistingOwner(resource.data.uid);
    }

    /**
     * @description Manages user profiles. Publicly readable, owner-write.
     */
    match /userProfiles/{userProfileId} {
      allow get, list: if true;
      allow create: if isOwner(userProfileId) && request.resource.data.userId == userProfileId && isCreatingUniqueUsername(userProfileId);
      allow update: if isExistingOwner(userProfileId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['bio', 'profilePicUrl']);
      allow delete: if isExistingOwner(userProfileId);

      /**
       * @description Manages a user's private habits.
       */
      match /habits/{habitId} {
        allow read, write, delete: if isOwner(userProfileId);
      }
    }

    /**
     * @description A single, top-level collection for all public posts.
     */
    match /global_posts/{postId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(request.resource.data.authorId);
      // Allow owner to update their post (but not change the author)
      allow update: if isExistingOwner(resource.data.authorId) && request.resource.data.authorId == resource.data.authorId;
      // Allow any signed-in user to update ONLY the likeIds field.
      allow update: if isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeIds']);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Manages likes on a specific post.
     * @path /global_posts/{postId}/likes/{likeId}
     * @allow (read) Anyone can read the likes on a post.
     * @allow (create) Any signed-in user can create a like for themself.
     * @allow (delete) A user can delete their own like.
     */
    match /global_posts/{postId}/likes/{likeId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid && request.resource.data.postId == postId;
      allow update: if false;
      allow delete: if isExistingOwner(resource.data.userId);
    }
  }
}
