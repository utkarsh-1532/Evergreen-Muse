{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user's profile information.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user profile."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the user in the authentication system. (Relationship: User 1:1 UserProfile)"
        },
        "username": {
          "type": "string",
          "description": "The user's unique username.",
          "format": "string"
        },
        "profilePicUrl": {
          "type": "string",
          "description": "URL of the user's profile picture.",
          "format": "uri"
        },
        "bio": {
          "type": "string",
          "description": "A short biography or description of the user."
        }
      },
      "required": [
        "id",
        "userId",
        "username"
      ]
    },
    "Post": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Post",
      "type": "object",
      "description": "Represents a user's post in the social feed.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the post."
        },
        "authorId": {
          "type": "string",
          "description": "Reference to the user who created the post. (Relationship: User 1:N Post)"
        },
        "title": {
          "type": "string",
          "description": "Title of the post."
        },
        "text": {
          "type": "string",
          "description": "Main text content of the post."
        },
        "imageUrl": {
          "type": "string",
          "description": "URL of the image attached to the post.",
          "format": "uri"
        },
        "imageCaption": {
          "type": "string",
          "description": "Caption for the image."
        },
        "songTitle": {
          "type": "string",
          "description": "Title of the song associated with the post."
        },
        "songArtist": {
          "type": "string",
          "description": "Artist of the song associated with the post."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp indicating when the post was created.",
          "format": "date-time"
        },
        "likeIds": {
          "type": "array",
          "description": "References to users who liked the post. (Relationship: User N:N Post via Like)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "authorId",
        "text",
        "timestamp"
      ]
    },
    "Like": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Like",
      "type": "object",
      "description": "Represents a like on a post by a user. This is an intermediary entity for the N:N relationship between User and Post.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the like."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the user who liked the post. (Relationship: User 1:N Like)"
        },
        "postId": {
          "type": "string",
          "description": "Reference to the post that was liked. (Relationship: Post 1:N Like)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp indicating when the post was liked.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "postId",
        "timestamp"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/userProfiles/{userProfileId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information. The 'userId' field links this profile to the Firebase Auth user. Enforces uniqueness of usernames.",
          "params": [
            {
              "name": "userProfileId",
              "description": "Unique identifier for the user profile document."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/posts/{postId}",
        "definition": {
          "entityName": "Post",
          "schema": {
            "$ref": "#/backend/entities/Post"
          },
          "description": "Stores user-generated posts. Includes 'authorId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who created the post."
            },
            {
              "name": "postId",
              "description": "The unique identifier for the post."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/posts/{postId}/likes/{likeId}",
        "definition": {
          "entityName": "Like",
          "schema": {
            "$ref": "#/backend/entities/Like"
          },
          "description": "Stores likes for each post. Includes 'userId' to track who liked the post.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who created the post."
            },
            {
              "name": "postId",
              "description": "The unique identifier for the post."
            },
            {
              "name": "likeId",
              "description": "The unique identifier for the like."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support a social page with user profiles, posts (including text, images, and music), and likes. It prioritizes authorization independence and efficient data retrieval.\n\n*   **User Profiles:** User profiles are stored in a dedicated collection (`userProfiles`) to ensure uniqueness of usernames and separation of concerns. The `userId` field establishes a 1:1 relationship with the Firebase Authentication user ID.\n*   **Posts:** Posts are stored in a collection group (`posts`). Each user has their own collection of posts (`/users/{userId}/posts/{postId}`). The `authorId` field in each post ensures clear ownership. This allows for efficient querying of posts by a specific user, and also for aggregation of all posts across all users (using collection groups).\n*   **Likes:** Likes are stored as subcollections under each post (`/users/{userId}/posts/{postId}/likes/{likeId}`). Each like document contains the `userId` of the user who liked the post and a timestamp. This structure allows for efficient querying of likes for a specific post.\n\n**Authorization Independence:**\n\n*   The structure avoids hierarchical authorization dependencies by storing the `authorId` directly within each post document. This allows security rules to validate the author of a post without needing to perform expensive `get()` operations to retrieve the user's information from a parent document.\n\n**QAPs (Rules are not Filters):**\n\n*   The structure supports secure `list` operations by segregating data based on ownership. Listing posts is secured by checking the `authorId` against the requesting user's `uid`. Listing likes is secured by checking if the user has permission to view the post and/or has liked the post. The use of collection groups allows for efficient querying of all posts, and security rules can be applied to collection groups to ensure that only authorized users can access the data."
  }
}